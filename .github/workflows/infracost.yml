# Copyright 2026 nnthanh101@gmail.com (oceansoft.io). Licensed under Apache-2.0. See LICENSE.
name: Infracost

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  cost:
    name: Infracost PR Cost Estimate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: FOCUS 1.2+ tag compliance check
        run: |
          pip install checkov --quiet 2>/dev/null
          mkdir -p tmp/terraform-aws/cost
          checkov -d modules/ \
            --external-checks-dir .checkov/custom_checks/ \
            --check CKV_CUSTOM_FOCUS_001 \
            --output json \
            --output-file-path tmp/terraform-aws/cost/ \
            --compact 2>/dev/null || true
          # Assert zero FOCUS tag violations (AC-2-08)
          FAILED=$(jq -r '.results.failed_checks | length' tmp/terraform-aws/cost/results_json.json 2>/dev/null || echo "0")
          if [ "$FAILED" -gt "0" ]; then
            echo "FAIL: $FAILED FOCUS 1.2+ tag compliance violations found"
            exit 1
          fi
          echo "PASS: FOCUS 1.2+ tag compliance â€” 0 violations"

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base

      - name: Infracost baseline (base branch)
        run: |
          for dir in base/examples/*/; do
            [ -d "$dir" ] || continue
            infracost breakdown --path "$dir" --format json \
              --out-file "/tmp/infracost-base-$(basename "$dir").json" 2>/dev/null || true
          done
          # Merge all base estimates
          find /tmp -name 'infracost-base-*.json' -print0 | \
            xargs -0 infracost output --format json --out-file /tmp/infracost-base.json 2>/dev/null || \
            echo '{"version":"0.2","totalMonthlyCost":"0","totalHourlyCost":"0","currency":"USD","projects":[],"timeGenerated":"'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}' > /tmp/infracost-base.json

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          path: pr

      - name: Infracost estimate (PR branch)
        run: |
          for dir in pr/examples/*/; do
            [ -d "$dir" ] || continue
            infracost breakdown --path "$dir" --format json \
              --out-file "/tmp/infracost-pr-$(basename "$dir").json" 2>/dev/null || true
          done
          find /tmp -name 'infracost-pr-*.json' -print0 | \
            xargs -0 infracost output --format json --out-file /tmp/infracost-pr.json 2>/dev/null || \
            echo '{"version":"0.2","totalMonthlyCost":"0","totalHourlyCost":"0","currency":"USD","projects":[],"timeGenerated":"'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}' > /tmp/infracost-pr.json

      - name: Infracost diff
        run: |
          infracost diff \
            --path /tmp/infracost-pr.json \
            --compare-to /tmp/infracost-base.json \
            --format json \
            --out-file /tmp/infracost-diff.json

      - name: Cost threshold gate ($5/month FAIL)
        run: |
          COST=$(jq -r '.totalMonthlyCost // "0"' /tmp/infracost-diff.json)
          echo "Estimated monthly cost delta: \$$COST"
          python3 -c "
          import sys, os
          cost = float('${COST}' or '0')
          if cost > 5:
              print('FAIL: Cost exceeds \$5/month threshold (HITL-003)')
              sys.exit(1)
          elif cost > 2.5:
              print('WARNING: Cost exceeds \$2.50/month advisory threshold')
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write('COST_WARNING=true\n')
          else:
              print(f'PASS: Cost delta \${cost:.2f}/month within threshold')
          "

      - name: Post cost warning to PR
        if: env.COST_WARNING == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Cost Warning\n\nMonthly delta in WARNING range ($2.50-$5.00). Review resource sizing before merging.\n\n> Infracost CI (AC-2-10)'
            });

      - name: Post PR comment
        uses: infracost/actions/comment@v1
        with:
          path: /tmp/infracost-diff.json
          behavior: update

      - name: Persist cost evidence
        if: always()
        run: |
          mkdir -p tmp/terraform-aws/cost-reports
          cp /tmp/infracost-diff.json "tmp/terraform-aws/cost-reports/infracost-diff-$(date +%Y-%m-%d).json" 2>/dev/null || true

      - name: Upload cost evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cost-estimate
          path: |
            /tmp/infracost-diff.json
            tmp/terraform-aws/cost-reports/
            tmp/terraform-aws/cost/

# Copyright 2026 nnthanh101@gmail.com (oceansoft.io). Licensed under Apache-2.0. See LICENSE.
name: Registry Publish

on:
  push:
    tags:
      - '*/v*'    # module-prefixed: iam-identity-center/v1.2.0, ecs-platform/v0.1.0
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (e.g., iam-identity-center/v1.1.3)'
        required: true
        type: string

permissions:
  contents: read

concurrency:
  group: registry-publish-${{ github.ref }}
  cancel-in-progress: true

jobs:
  resolve:
    name: Resolve Module from Tag
    runs-on: ubuntu-latest
    outputs:
      module: ${{ steps.module-info.outputs.module }}
      version: ${{ steps.module-info.outputs.version }}
      module_dir: ${{ steps.module-info.outputs.module_dir }}
      tag_ref: ${{ steps.module-info.outputs.tag_ref }}
    steps:
      - name: Extract module info from tag
        id: module-info
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          if [[ "$TAG" == *"/"* ]]; then
            MODULE_NAME="${TAG%/v*}"
            MODULE_VERSION="${TAG#*/}"
          else
            echo "FAIL: Tag '$TAG' is not per-module format (expected: MODULE/vX.Y.Z)" && exit 1
          fi
          echo "module=${MODULE_NAME}" >> "$GITHUB_OUTPUT"
          echo "version=${MODULE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "module_dir=modules/${MODULE_NAME}" >> "$GITHUB_OUTPUT"
          # Normalize to refs/tags/ prefix for actions/checkout compatibility
          echo "tag_ref=refs/tags/${TAG}" >> "$GITHUB_OUTPUT"
          echo "Resolved: module=${MODULE_NAME}, version=${MODULE_VERSION}, dir=modules/${MODULE_NAME}, tag_ref=refs/tags/${TAG}"

  validate:
    name: Validate & Lint (${{ needs.resolve.outputs.module }})
    needs: [resolve]
    runs-on: ubuntu-latest
    container:
      image: nnthanh101/terraform:2.6.0@sha256:3e159226f661171fb26baa360af7ddc0809076376a3cd6c37b8614186770f16a
      options: --user 0
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.tag_ref }}

      - name: Quick CI (fmt + validate + lint + legal)
        env:
          MODULE: ${{ needs.resolve.outputs.module }}
          MODULE_DIR: ${{ needs.resolve.outputs.module_dir }}
        run: task ci:quick

  test:
    name: Tier 1 Snapshot Tests (${{ needs.resolve.outputs.module }})
    needs: [resolve, validate]
    runs-on: ubuntu-latest
    container:
      image: nnthanh101/terraform:2.6.0@sha256:3e159226f661171fb26baa360af7ddc0809076376a3cd6c37b8614186770f16a
      options: --user 0
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.tag_ref }}

      - name: Run Tier 1 tests (snapshot tests, $0 cost)
        env:
          MODULE: ${{ needs.resolve.outputs.module }}
          MODULE_NAME: ${{ needs.resolve.outputs.module }}
          MODULE_DIR: ${{ needs.resolve.outputs.module_dir }}
        run: |
          set -o pipefail
          mkdir -p "tmp/terraform-aws/registry-publish/${MODULE_NAME}"
          task test:tier1 2>&1 | tee "tmp/terraform-aws/registry-publish/${MODULE_NAME}/tier1-snapshot.log"
          TEST_EXIT=$?
          echo "exit_code=${TEST_EXIT}" >> "tmp/terraform-aws/registry-publish/${MODULE_NAME}/tier1-summary.txt"
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "tmp/terraform-aws/registry-publish/${MODULE_NAME}/tier1-summary.txt"
          echo "module=${MODULE_NAME}" >> "tmp/terraform-aws/registry-publish/${MODULE_NAME}/tier1-summary.txt"
          echo "tag=${GITHUB_REF_NAME:-unknown}" >> "tmp/terraform-aws/registry-publish/${MODULE_NAME}/tier1-summary.txt"
          exit $TEST_EXIT

      - name: Upload test evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ needs.resolve.outputs.module }}
          path: tmp/terraform-aws/registry-publish/${{ needs.resolve.outputs.module }}/

  release:
    name: Create GitHub Release (${{ needs.resolve.outputs.module }} ${{ needs.resolve.outputs.version }})
    needs: [resolve, test]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Create release (idempotent — skip if exists)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MODULE_NAME: ${{ needs.resolve.outputs.module }}
          MODULE_VERSION: ${{ needs.resolve.outputs.version }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          RELEASE_TITLE="${MODULE_NAME} ${MODULE_VERSION}"
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists — skipping"
          else
            gh release create "$TAG" --generate-notes --title "${RELEASE_TITLE}"
          fi

  publish:
    name: Publish to TFC (${{ needs.resolve.outputs.module }} ${{ needs.resolve.outputs.version }})
    needs: [resolve, test, release]
    if: always() && needs.test.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.tag_ref }}

      - name: Create clean module tarball
        env:
          MODULE_DIR: ${{ needs.resolve.outputs.module_dir }}
        run: |
          tar -czf /tmp/module.tar.gz \
            --exclude='.terraform' \
            --exclude='.terraform.lock.hcl' \
            --exclude='.config' \
            --exclude='.project_automation' \
            --exclude='.pre-commit-config.yaml' \
            --exclude='.copier-answers.yml' \
            --exclude='.project_config.yml' \
            --exclude='.checkov.yml' \
            -C "${MODULE_DIR}" .

      - name: Create TFC module version
        id: create-version
        env:
          TFE_TOKEN: ${{ secrets.TFE_TOKEN }}
          MODULE_NAME: ${{ needs.resolve.outputs.module }}
          MODULE_VERSION: ${{ needs.resolve.outputs.version }}
        run: |
          VERSION="${MODULE_VERSION#v}"
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${TFE_TOKEN}" \
            -H "Content-Type: application/vnd.api+json" \
            -d "{\"data\":{\"type\":\"registry-module-versions\",\"attributes\":{\"version\":\"${VERSION}\"}}}" \
            "https://app.terraform.io/api/v2/organizations/oceansoft/registry-modules/private/oceansoft/${MODULE_NAME}/aws/versions")
          UPLOAD_URL=$(echo "$RESPONSE" | jq -r '.data.links.upload')
          if [ "$UPLOAD_URL" = "null" ] || [ -z "$UPLOAD_URL" ]; then
            echo "ERROR: Failed to create version — check TFE_TOKEN and module exists"
            echo "$RESPONSE" | jq .
            exit 1
          fi
          echo "upload_url=${UPLOAD_URL}" >> "$GITHUB_OUTPUT"
          echo "Created version ${VERSION}, upload URL obtained"

      - name: Upload module to TFC
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X PUT -H "Content-Type: application/octet-stream" \
            --data-binary @/tmp/module.tar.gz \
            "${{ steps.create-version.outputs.upload_url }}")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: Upload failed with HTTP ${HTTP_CODE}"
            exit 1
          fi
          echo "Upload successful (HTTP ${HTTP_CODE})"

      - name: Verify TFC ingestion
        env:
          TFE_TOKEN: ${{ secrets.TFE_TOKEN }}
          MODULE_NAME: ${{ needs.resolve.outputs.module }}
          MODULE_VERSION: ${{ needs.resolve.outputs.version }}
        run: |
          VERSION="${MODULE_VERSION#v}"
          for i in 1 2 3 4 5; do
            sleep 5
            STATUS=$(curl -s \
              -H "Authorization: Bearer ${TFE_TOKEN}" \
              "https://app.terraform.io/api/v2/organizations/oceansoft/registry-modules/private/oceansoft/${MODULE_NAME}/aws" \
              | jq -r ".data.attributes.\"version-statuses\"[] | select(.version==\"${VERSION}\") | .status")
            echo "Attempt ${i}: version ${VERSION} status = ${STATUS}"
            if [ "$STATUS" = "ok" ]; then
              echo "TFC Registry publish verified: ${MODULE_NAME} v${VERSION} ✓"
              exit 0
            fi
          done
          echo "ERROR: Version ${VERSION} did not reach 'ok' status after 25s"
          exit 1

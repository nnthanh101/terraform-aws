# Copyright 2026 nnthanh101@gmail.com (oceansoft.io). Licensed under Apache-2.0. See LICENSE.
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: Validate & Lint (${{ matrix.module }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module: [iam-identity-center]  # expand: ecs-platform, fullstack-web
    container:
      image: nnthanh101/terraform:2.6.0@sha256:3e159226f661171fb26baa360af7ddc0809076376a3cd6c37b8614186770f16a
      options: --user 0
    steps:
      - uses: actions/checkout@v4

      - name: Terraform fmt + validate
        run: task build:validate

      - name: Lint (tflint + checkov)
        run: task build:lint

  legal:
    name: Legal Audit
    runs-on: ubuntu-latest
    container:
      image: nnthanh101/terraform:2.6.0@sha256:3e159226f661171fb26baa360af7ddc0809076376a3cd6c37b8614186770f16a
      options: --user 0
    steps:
      - uses: actions/checkout@v4

      - name: Apache 2.0 compliance (5 checks)
        run: task govern:legal

      - name: Upload legal evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: legal-audit
          path: tmp/terraform-aws/legal-audit/

  governance:
    name: Governance Score
    runs-on: ubuntu-latest
    container:
      image: nnthanh101/terraform:2.6.0@sha256:3e159226f661171fb26baa360af7ddc0809076376a3cd6c37b8614186770f16a
      options: --user 0
    steps:
      - uses: actions/checkout@v4

      - name: Constitutional checkpoint (>=85%)
        run: task govern:score

      - name: APRA CPS 234 compliance (Para 15/36/37)
        run: task govern:cps234

      - name: Upload governance evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: governance-score
          path: |
            tmp/terraform-aws/governance/
            tmp/terraform-aws/test-results/

  test:
    name: CI-Safe Tests (Tier 1 + 2, no AWS cost)
    needs: [validate]
    runs-on: ubuntu-latest
    container:
      image: nnthanh101/terraform:2.6.0@sha256:3e159226f661171fb26baa360af7ddc0809076376a3cd6c37b8614186770f16a
      options: --user 0
    steps:
      - uses: actions/checkout@v4

      - name: Run CI test suite (no HITL gate)
        run: task test:ci

  lock-verify:
    name: Lock File Verification
    runs-on: ubuntu-latest
    container:
      image: nnthanh101/terraform:2.6.0@sha256:3e159226f661171fb26baa360af7ddc0809076376a3cd6c37b8614186770f16a
      options: --user 0
    steps:
      - uses: actions/checkout@v4

      - name: Verify .terraform.lock.hcl exists per module
        run: task build:lock-verify

  security:
    name: Security Scan (Trivy)
    runs-on: ubuntu-latest
    container:
      image: nnthanh101/terraform:2.6.0@sha256:3e159226f661171fb26baa360af7ddc0809076376a3cd6c37b8614186770f16a
      options: --user 0
    steps:
      - uses: actions/checkout@v4

      - name: Trivy misconfig scan
        run: task security:trivy

      - name: Upload security evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan
          path: tmp/terraform-aws/security-scans/
